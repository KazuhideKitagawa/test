# ワークフローの名前
name: '🎨 Draw.io -> SVG 自動変換'

# ワークフローが実行されるトリガーを定義
on:
  push:
    # どのブランチでも、.drawioファイルが変更されたら実行
    paths:
      - '**.drawio'

# 実行する一連のタスク（ジョブ）を定義
jobs:
  export:
    # ubuntuの最新版環境で実行
    runs-on: ubuntu-latest

    # 実行するステップを定義
    steps:
      # --- ステップ1: リポジトリのコードをチェックアウト ---
      - name: '📂 リポジトリをチェックアウト'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: remove old svg for changed .drawio
        run: |
          git fetch origin ${{ github.event.before }}
        git diff --name-only ${{ github.event.before }} ${{ github.sha } -- '*.drawio' | while read drawio_file; do
          base_name=$(basename "$drawio_file" .drawio)
          dir_name=$(dirname "$drawio_file")
          rm -f "$dir_name/${base_name}"_*.svg
        done


      # --- ステップ2: Draw.ioファイルをSVGに変換 ---
      - name: '🖌️ Draw.ioファイルをSVGにエクスポート'
        # ★★★ ここを v4 に修正しました ★★★
        uses: rlespinasse/drawio-export-action@v2
        with:
          # リポジトリ内のすべての.drawioファイルを対象にする
          path: .
          output: .
          # 出力するフォーマット
          format: 'svg'
          
      # --- ステップ3: 生成されたファイルをリポジトリにコミット ---
      - name: '💾 変更をコミット'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # コミットメッセージ
          commit_message: 'docs(diagrams): Draw.ioからSVGを自動生成'
          
          # コミット対象のファイルパターン
          file_pattern: '**/*.svg'
