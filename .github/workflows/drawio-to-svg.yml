# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åå‰
name: 'ğŸ¨ Draw.io -> SVG è‡ªå‹•å¤‰æ›'

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’å®šç¾©
on:
  push:
    # ã©ã®ãƒ–ãƒ©ãƒ³ãƒã§ã‚‚ã€.drawioãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰å®Ÿè¡Œ
    paths:
      - '**.drawio'

# å®Ÿè¡Œã™ã‚‹ä¸€é€£ã®ã‚¿ã‚¹ã‚¯ï¼ˆã‚¸ãƒ§ãƒ–ï¼‰ã‚’å®šç¾©
jobs:
  export:
    # ubuntuã®æœ€æ–°ç‰ˆç’°å¢ƒã§å®Ÿè¡Œ
    runs-on: ubuntu-latest

    # å®Ÿè¡Œã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®šç¾©
    steps:
      # --- ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ ---
      - name: 'ğŸ“‚ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: remove old svg for changed .drawio
        run: |
          git fetch origin ${{ github.event.before }}
        git diff --name-only ${{ github.event.before }} ${{ github.sha } -- '*.drawio' | while read drawio_file; do
          base_name=$(basename "$drawio_file" .drawio)
          dir_name=$(dirname "$drawio_file")
          rm -f "$dir_name/${base_name}"_*.svg
        done


      # --- ã‚¹ãƒ†ãƒƒãƒ—2: Draw.ioãƒ•ã‚¡ã‚¤ãƒ«ã‚’SVGã«å¤‰æ› ---
      - name: 'ğŸ–Œï¸ Draw.ioãƒ•ã‚¡ã‚¤ãƒ«ã‚’SVGã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ'
        # â˜…â˜…â˜… ã“ã“ã‚’ v4 ã«ä¿®æ­£ã—ã¾ã—ãŸ â˜…â˜…â˜…
        uses: rlespinasse/drawio-export-action@v2
        with:
          # ãƒªãƒã‚¸ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®.drawioãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¯¾è±¡ã«ã™ã‚‹
          path: .
          output: .
          # å‡ºåŠ›ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          format: 'svg'
          
      # --- ã‚¹ãƒ†ãƒƒãƒ—3: ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆ ---
      - name: 'ğŸ’¾ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          commit_message: 'docs(diagrams): Draw.ioã‹ã‚‰SVGã‚’è‡ªå‹•ç”Ÿæˆ'
          
          # ã‚³ãƒŸãƒƒãƒˆå¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³
          file_pattern: '**/*.svg'
